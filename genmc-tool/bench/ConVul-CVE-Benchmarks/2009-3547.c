#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

struct pipe_inode_info {
    unsigned int writers;
    unsigned int readers;
};

struct INODE {
    pthread_mutex_t i_mutex;
    struct pipe_inode_info *i_pipe;
};

struct pipe_inode_info* create_pipe_inode_info() {
    struct pipe_inode_info* info = (struct pipe_inode_info*)malloc(sizeof(struct pipe_inode_info));
    if (info) {
        info->writers = 0;
        info->readers = 0;
    }
    return info;
}

struct INODE* create_inode() {
    struct INODE* inode = (struct INODE*)malloc(sizeof(struct INODE));
    if (inode) {
        pthread_mutex_init(&inode->i_mutex, NULL);
        inode->i_pipe = create_pipe_inode_info();
    }
    return inode;
}

struct INODE* inode;

void* pipe_write_open(void* arg) {
    pthread_mutex_lock(&inode->i_mutex);
    inode->i_pipe->readers++;
    printf("threadA: %p\n", (void*)inode->i_pipe);
    pthread_mutex_unlock(&inode->i_mutex);
    return NULL;
}

void* involve(void* arg) {
    pthread_mutex_lock(&inode->i_mutex);
    inode->i_pipe = NULL;
    pthread_mutex_unlock(&inode->i_mutex);
    printf("threadB: %p\n", (void*)inode->i_pipe);
    return NULL;
}

int main() {
    #ifdef TEST_TIME
    double run_time_begin, run_time_end, run_time_total;
    run_time_begin = clock();
    #endif

    inode = create_inode();

    pthread_t t1, t2;
    pthread_create(&t1, NULL, pipe_write_open, NULL);
    pthread_create(&t2, NULL, involve, NULL);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);

    printf("\nprogram-successful-exit\n");

    #ifdef TEST_TIME
    run_time_end = clock();
    run_time_total = run_time_end - run_time_begin;
    printf("test-the-total-time: %.3lf\n", (double)(run_time_total / CLOCKS_PER_SEC) * 1000);
    #endif

    return 0;
}
